<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Marseille ¬∑ Lyc√©es pro + itin√©raires (Google)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --public:#16a34a;   /* lyc√©es publics */
      --prive:#7c3aed;    /* lyc√©es priv√©s */
      --school-bg:#f1f5f9; --school-bd:#cbd5e1; --school-fg:#111827;
      --m1:#2563eb; --m2:#ef4444; --tram:#10b981; --walk:#9ca3af; --bus:#f59e0b;
    }
    html, body { height:100%; margin:0; font-family: Inter, system-ui, sans-serif; }
    #map{ height:100%; width:100%; }
    .school-label{ color:var(--school-fg); font-weight:400; font-size:10px; background:var(--school-bg); border:1px solid var(--school-bd); padding:1px 3px; border-radius:4px; box-shadow:0 1px 2px rgba(0,0,0,.08); }
    .panel{ position:fixed; z-index:10000; background:#ffffffcc; backdrop-filter:saturate(1.1) blur(4px); border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.08); padding:10px 12px; max-width:380px; font-size:13px; color:#111827; }
    #routePanel{ right:12px; top:12px; display:none; }
    #formsPanel{ position:fixed; left:64px; bottom:160px; display:none; max-height:44vh; overflow:auto; }
    .panel h4{ margin:0 0 6px; font-size:13px; font-weight:700; }
    .time{ display:inline-block; padding:2px 8px; border-radius:999px; background:#111827; color:#fff; font-weight:700; }
    .tag{ display:inline-block; padding:2px 6px; border-radius:6px; background:#f1f5f9; border:1px solid #e5e7eb; font-size:12px; white-space:normal; margin:2px; }
    .row{ margin-top:6px; }
    .gt-logo{ width:28px; height:28px; display:grid; place-items:center; border-radius:50%; background:#fff; border:2px solid #fff; box-shadow:0 1px 3px rgba(0,0,0,.35); overflow:hidden; }
    .gt-logo img{ width:100%; height:100%; object-fit:cover; display:block; }
    .brandLogo{ height:22px; width:auto; display:block; }
    .toolbar{ position:fixed; left:12px; top:12px; z-index:10001; background:#fff; border:1px solid #e5e7eb; border-radius:10px; padding:8px 10px; font-size:12px; display:flex; flex-direction:column; gap:6px; }
    .toolbar .from{ display:flex; align-items:center; gap:6px; }
    .toolbar input{ width:260px; padding:6px 8px; font-size:12px; border:1px solid #e5e7eb; border-radius:8px; }
    .toolbar button{ font-size:12px; padding:6px 8px; border:1px solid #e5e7eb; background:#f8fafc; border-radius:8px; cursor:pointer; }
    #status{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:10002; background:#0f172acc; color:#e2e8f0; padding:6px 10px; border-radius:8px; font:12px/1.4 Inter,system-ui; }
    .legend{ display:flex; gap:10px; margin-top:6px; flex-wrap:wrap; }
    .leg{ display:flex; align-items:center; gap:6px; font-size:12px; color:#374151; }
    .leg i{ display:inline-block; width:20px; height:4px; border-radius:2px; }
    .leg .m1{ background:var(--m1); } .leg .m2{ background:var(--m2); } .leg .tram{ background:var(--tram); } .leg .bus{ background:var(--bus); } .leg .walk{ background:var(--walk); }
    .panel.small{ padding:8px 10px; font-size:12px; }
    #legendSchools{ position:fixed; left:12px; bottom:12px; z-index:10002; }
    .dot{ width:10px; height:10px; border-radius:50%; display:inline-block; margin-right:6px; border:1px solid #fff; box-shadow:0 0 0 1px #e5e7eb inset; }
    .dot.pub{ background:var(--public); }
    .dot.priv{ background:var(--prive); }
    .leaflet-bottom.leaflet-left .leaflet-control-zoom{ margin-bottom:120px; }
    #brandBR{ position:fixed; right:12px; bottom:12px; z-index:10002; background:transparent; border:none; box-shadow:none; }
    #brandBR img{ height:132px;  width:auto; opacity:.95; display:block; }
    .gt-emoji{ width:26px; height:26px; display:grid; place-items:center; border-radius:999px; background:#fff; border:2px solid #fff; box-shadow:0 1px 3px rgba(0,0,0,.35); font-size:14px; }
    .toolbar .filter{ display:flex; align-items:center; gap:6px; }
    .count{ padding:2px 6px; border-radius:999px; background:#eef2ff; border:1px solid #e5e7eb; font-size:11px; color:#334155; }
  </style>
</head>
<body>
<noscript>Active JavaScript pour voir la carte.</noscript>
<div id="map"></div>
<div class="toolbar">
  <div class="from">
    <input id="originInput" type="text" placeholder="Adresse de d√©part (ex: 26 Av. des Caillols)" />
    <button id="useLoc" title="Utiliser ma position">üìç Ma position</button>
  </div>
  <div class="filter">
    <input id="filterInput" type="text" placeholder="Rechercher une formation (ex: √©lectricit√©, enfance‚Ä¶)" />
    <button id="applyFilter">Filtrer</button>
    <button id="resetFilter">R√©initialiser</button>
    <span id="filterCount" class="count" style="display:none"></span>
  </div>
</div>
<div id="routePanel" class="panel">
  <h4>Itin√©raire (d√©part 07:30)</h4>
  <div>Temps total : <span id="routeTime" class="time">‚Äî</span></div>
  <div id="routeSteps" class="row"></div>
  <div class="legend">
    <div class="leg"><i class="m1"></i>M√©tro M1</div>
    <div class="leg"><i class="m2"></i>M√©tro M2</div>
    <div class="leg"><i class="tram"></i>Tram</div>
    <div class="leg"><i class="bus"></i>Bus</div>
    <div class="leg"><i class="walk"></i>√Ä pied</div>
  </div>
  <button id="clearRoute">Effacer l'itin√©raire</button>
</div>
<div id="formsPanel" class="panel" style="left:64px; bottom:160px; display:none; max-height:44vh; overflow:auto;">
  <h4 id="formsTitle">Formations</h4>
  <div id="formsContent"></div>
</div>
<div id="legendSchools" class="panel small">
  <div><span class="dot pub"></span>Public</div>
  <div><span class="dot priv"></span>Priv√©</div>
  <div style="margin-top:6px;font-size:11px;color:#64748b">outil d√©velopp√© par <strong>Rachid Zerrouki</strong></div>
</div>
<div id="brandBR"><img src="https://i.ibb.co/Pv8MYpVt/logo-college-png.png" alt="Logo coll√®ge" /></div>
<div id="status">Initialisation‚Ä¶</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// ----- Carte Leaflet d'abord -----
const map = L.map('map').setView([43.295, 5.375], 12);
map.zoomControl.setPosition('bottomleft');
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', { attribution:'¬© OpenStreetMap, ¬© CARTO', subdomains:'abcd', maxZoom:19 }).addTo(map);

const statusEl = document.getElementById('status');
function setStatus(t){ if(statusEl) statusEl.textContent=t; }
function getCSS(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim()||'#000'; }

// Panneaux
const routeLayerGroup = L.layerGroup().addTo(map);
const schoolMarkers = []; // { marker, data, coords, searchText }
const routePanel = document.getElementById('routePanel');
const routeTimeEl = document.getElementById('routeTime');
const routeStepsEl = document.getElementById('routeSteps');

document.getElementById('clearRoute').onclick = ()=>{ routeLayerGroup.clearLayers(); routePanel.style.display='none'; };

// ----- Donn√©es -----
const LYCEES = [
  { nom:"Lyc√©e Don Bosco", statut:"Priv√©", adresse:"30 rue des Trois-Fr√®res-Carasso, 13006 Marseille",
    cap:["CAP Menuisier fabricant","CAP M√©tallier","CAP Signal√©tique et d√©cors graphiques","CAP √âlectricien"],
    bac:[],
    seconde:["2nd pro M√©tiers des industries graphiques et de la communication","2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique","2nd pro M√©tiers du pilotage et de la maintenance d'installations automatis√©es"] },
  { nom:"Lyc√©e Fr√©d√©ric Mistral", statut:"Public", adresse:"Boulevard Sainte-Anne, 13008 Marseille, France",
    cap:["CAP Carrossier automobile","CAP Maintenance des v√©hicules ‚Äì option v√©hicules l√©gers","CAP Signal√©tique et d√©cors graphiques"],
    bac:[],
    seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la maintenance des mat√©riels et des v√©hicules","2nd pro M√©tiers de la relation client"] },
  { nom:"Lyc√©e Blaise Pascal", statut:"Public", adresse:"49 Traverse Capron, 13012 Marseille",
    cap:["CAP Cordonnerie multiservice","CAP Op√©rateur en appareillage orthop√©dique ‚Äì sp√©cialit√© orthoproth√®se"],
    bac:[],
    seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la r√©alisation d'ensembles m√©caniques et industriels"] },
  { nom:"Lyc√©e Simone Veil", statut:"Public", adresse:"Avenue des P√¢querettes, BP 60149, 13013 Marseille",
    cap:[], bac:["Bac pro Hygi√®ne, propret√©, st√©rilisation (HPS)"], seconde:[] },
  { nom:"Lyc√©e Jean Perrin", statut:"Public", adresse:"74 Rue Verdillon, 13010 Marseille",
    cap:["CAP Composites, plastiques chaudronn√©s","CAP R√©alisations industrielles en chaudronnerie ou soudage ‚Äì option A chaudronnerie"],
    bac:[],
    seconde:["2nd pro M√©tiers de la r√©alisation d'ensembles m√©caniques et industriels","2nd pro M√©tiers du pilotage et de la maintenance d'installations automatis√©es"] },
  { nom:"Lyc√©e Antonin Artaud", statut:"Public", adresse:"25 chemin Notre-Dame-de-la-Consolation, 13013 Marseille",
    cap:["CAP √âlectricien"], bac:["Bac pro M√©tiers de l'√©lectricit√© et de ses environnements connect√©s (MELEC)"],
    seconde:["2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique"] },
  { nom:"Lyc√©e H√¥telier Jean-Paul Pass√©dat", statut:"Public", adresse:"114 avenue Andr√©-Zenatti, 13008 Marseille",
    cap:["CAP Boulanger","CAP Commercialisation et services en h√¥tel-caf√©-restaurant (CSHCR)","CAP Cuisine","CAP P√¢tissier"],
    bac:[], seconde:["2nd pro M√©tiers de l'alimentation","2nd pro M√©tiers de l'h√¥tellerie-restauration"] },
  { nom:"Lyc√©e Colbert", statut:"Public", adresse:"13 Rue Capitaine Dessemond, 13007 Marseille",
    cap:["CAP Accompagnant √©ducatif petite enfance (AEPE)","CAP Agent accompagnant au grand √¢ge","CAP Production et service en restaurations (rapide, collective, caf√©t√©ria) (PSR)","CAP √âquipier polyvalent du commerce (EPC)"],
    bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la relation client"] },
  { nom:"Lyc√©e Poinso-Chapuis", statut:"Public", adresse:"6-8 avenue Viton, 13008 Marseille",
    cap:["CAP Maintenance nautique","CAP √âb√©niste"], bac:[], seconde:["2nd pro M√©tiers de l'agencement, de la menuiserie et de l'ameublement"] },
  { nom:"Lyc√©e Jacques Raynaud", statut:"Priv√©", adresse:"4 boulevard Jean-Labro, 13013 Marseille",
    cap:["CAP Agent de s√©curit√©","CAP Installateur en froid et conditionnement d'air","CAP Maintenance des v√©hicules ‚Äì option v√©hicules l√©gers"],
    bac:[], seconde:["2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique","2nd pro M√©tiers du pilotage et de la maintenance d'installations automatis√©es"] },
  { nom:"Lyc√©e La Floride", statut:"Public", adresse:"54 Bd Gay Lussac, 13014 Marseille",
    cap:["CAP Conducteur routier de marchandises ‚Äì option livraisons de proximit√©","CAP Conducteur routier de marchandises ‚Äì option livraisons longue distance","CAP Maintenance des v√©hicules ‚Äì option motocycles","CAP Maintenance des v√©hicules ‚Äì option v√©hicules de transport routier","CAP Op√©rateur/op√©ratrice logistique","CAP √âlectricien"],
    bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la maintenance des mat√©riels et des v√©hicules","2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique"] },
  { nom:"Lyc√©e Edmond Rostand", statut:"Public", adresse:"68 boulevard √âmile-Sicard, 13008 Marseille",
    cap:["CAP Accompagnant √©ducatif petite enfance (AEPE)"], bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique"] },
  { nom:"Lyc√©e Camille Jullian", statut:"Public", adresse:"50 boulevard de la Barasse, 13011 Marseille",
    cap:["CAP Agent accompagnant au grand √¢ge","CAP Production et service en restaurations (PSR)","CAP √âquipier polyvalent du commerce (EPC)"],
    bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la relation client"] },
  { nom:"Lyc√©e La Calade ‚Äì Jane Vialle", statut:"Public", adresse:"430 chemin de la Madrague-Ville, 13015 Marseille",
    cap:["CAP Esth√©tique cosm√©tique parfumerie","CAP M√©tiers de la mode ‚Äì V√™tement flou","CAP √âquipier polyvalent du commerce (EPC)"],
    bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la relation client"] },
  { nom:"Lyc√©e Saint-Michel", statut:"Priv√©", adresse:"75 rue Saint-Savournin, 13005 Marseille",
    cap:[], bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la relation client"] },
  { nom:"Lyc√©e Grande Bastide", statut:"Priv√©", adresse:"32 traverse Pastr√©, 13009 Marseille",
    cap:[], bac:[], seconde:["2nd pro M√©tiers de l'h√¥tellerie-restauration"] },
  { nom:"Lyc√©e des Calanques", statut:"Public", adresse:"89 Traverse Parangon, 13008 Marseille, France",
    cap:["CAPa Jardinier paysagiste"], bac:[], seconde:["2nd pro Nature-Jardin-Paysage-For√™t"] },
  { nom:"Lyc√©e de l'Estaque", statut:"Public", adresse:"310 Rue Rabelais, 13016 Marseille, France",
    cap:["CAP Agent de s√©curit√©","CAP Maintenance nautique","CAP √âlectricien","CAP √âquipier polyvalent du commerce"],
    bac:[], seconde:["2nd pro M√©tiers de la relation client","2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique"] },
  { nom:"Lyc√©e Jean-Baptiste Brochier", statut:"Public", adresse:"9 Bd Mireille Lauze, 13010 Marseille",
    cap:["CAP Accompagnant √©ducatif petite enfance (AEPE)","CAP Maroquinerie","CAP M√©tiers de la mode ‚Äì V√™tement flou"],
    bac:[], seconde:["2nd pro M√©tiers de la relation client"] },
  { nom:"Lyc√©e La Viste", statut:"Public", adresse:"30 Traverse Bonnet, 13015 Marseille",
    cap:["CAP Accompagnant √©ducatif petite enfance (AEPE)","CAP Production et service en restaurations (PSR)","CAP √âquipier polyvalent du commerce (EPC)"],
    bac:[], seconde:["2nd pro M√©tiers de la relation client"] },
  { nom:"Lyc√©e Amp√®re", statut:"Public", adresse:"56 Bd Romain Rolland, 13010 Marseille",
    cap:["CAP Agent de s√©curit√©","CAP Installateur en froid et conditionnement d'air","CAP √âlectricien"],
    bac:[], seconde:["2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique"] }
];

const DEFAULT_ORIGIN = { lat:43.2946, lon:5.4522, label:'Coll√®ge Germaine Tillion' };
let ORIGIN = { ...DEFAULT_ORIGIN };
const COLLEGE_NAME = 'Coll√®ge Germaine Tillion';
const COLLEGE_ADDR = '26 Avenue des Caillols, 13012 Marseille, France';
let gtMarker = null;
function placeCollegeMarker(lat, lon){
  if(gtMarker){ map.removeLayer(gtMarker); }
  gtMarker = L.marker([lat,lon],{ icon: L.divIcon({className:'', html:"<div class='gt-emoji'>üè´</div>", iconSize:[26,26], iconAnchor:[13,13]}) }).addTo(map);
  gtMarker.bindTooltip(COLLEGE_NAME,{permanent:true,direction:'top',offset:[0,-14],className:'school-label'}).openTooltip();
}
let originMarker = L.circleMarker([ORIGIN.lat,ORIGIN.lon],{radius:7,color:'#2563eb',fillColor:'#3b82f6',fillOpacity:0.9,weight:2}).addTo(map);
originMarker.bindTooltip('D√©part : '+ORIGIN.label,{permanent:true,direction:'right',offset:[10,0],className:'school-label'}).openTooltip();

window.__gmReady = function(){ try{ onGoogleReady(); }catch(e){ console.error(e); setStatus('Erreur Google'); } };
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjI0_fpHfli1TVjyDPmFGIQfhZkm7HGG4&language=fr&libraries=places,geometry&callback=__gmReady" defer></script>
<script>
function onGoogleReady(){
  setStatus('Placement des lyc√©es‚Ä¶');
  const geocoder = new google.maps.Geocoder();
  const placesSvc = new google.maps.places.PlacesService(document.createElement('div'));
  const coordsCacheKey = 'gm_coords_v2';
  let COORDS = {}; try{ COORDS = JSON.parse(localStorage.getItem(coordsCacheKey)||'{}'); }catch(e){ COORDS={}; }
  const saveCoords = ()=> localStorage.setItem(coordsCacheKey, JSON.stringify(COORDS));
  if(COORDS["Lyc√©e La Floride"]) { delete COORDS["Lyc√©e La Floride"]; saveCoords(); }

  // -------- Autocomplete + position --------
  const originInput = document.getElementById('originInput');
  const useLocBtn = document.getElementById('useLoc');
  try{
    const ac = new google.maps.places.Autocomplete(originInput,{ componentRestrictions:{country:'fr'}, fields:['geometry','formatted_address','name'] });
    ac.addListener('place_changed', ()=>{ const p=ac.getPlace(); if(p?.geometry?.location){ const lat=p.geometry.location.lat(), lon=p.geometry.location.lng(); setOrigin(lat,lon,p.formatted_address||p.name); }});
  }catch(e){ console.warn('Autocomplete KO', e); }
  originInput.addEventListener('keydown', e=>{
    if(e.key==='Enter'){
      const q=originInput.value.trim(); if(!q) return;
      placesSvc.findPlaceFromQuery({ query:q, fields:['geometry','name','formatted_address'] }, (res,status)=>{
        if(status==='OK' && res?.[0]?.geometry){
          const g=res[0].geometry.location;
          setOrigin(g.lat(), g.lng(), res[0].formatted_address||res[0].name);
        }
      });
    }
  });
  useLocBtn.onclick = ()=>{
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        pos=>{ setOrigin(pos.coords.latitude, pos.coords.longitude, 'Ma position'); },
        ()=> alert('Position inaccessible.')
      );
    } else { alert('G√©olocalisation non support√©e.'); }
  };

  function setOrigin(lat, lon, label){
    ORIGIN = {lat, lon, label:label||'D√©part'};
    if(originMarker){ map.removeLayer(originMarker); }
    originMarker = L.circleMarker([lat,lon],{radius:7,color:'#2563eb',fillColor:'#3b82f6',fillOpacity:0.9,weight:2}).addTo(map);
    originMarker.bindTooltip('D√©part : '+ORIGIN.label,{permanent:true,direction:'right',offset:[10,0],className:'school-label'}).openTooltip();
  }

  function decodePolylinePts(points){ const path = google.maps.geometry.encoding.decodePath(points); return path.map(p=>[p.lat(), p.lng()]); }
  function drawPolyline(latlngs, color, weight, dash){ return L.polyline(latlngs, {color, weight:weight||4, opacity:0.95, dashArray:dash||null}).addTo(routeLayerGroup); }

  function nextDepartureTime(hour, minute){
    const now=new Date(); const t=new Date();
    t.setHours(hour||7, minute||30, 0, 0);
    if(t<=now) t.setDate(t.getDate()+1);
    return t;
  }

  function routeTo(dest){
    const svc = new google.maps.DirectionsService();
    const departure = nextDepartureTime(7,30);
    svc.route({
      origin: new google.maps.LatLng(ORIGIN.lat, ORIGIN.lon),
      destination: new google.maps.LatLng(dest.lat, dest.lon),
      travelMode: google.maps.TravelMode.TRANSIT,
      transitOptions: { modes: [google.maps.TransitMode.BUS, google.maps.TransitMode.SUBWAY, google.maps.TransitMode.TRAM], departureTime: departure },
      region: 'FR', provideRouteAlternatives: false
    }, (res,status)=>{
      routeLayerGroup.clearLayers();
      if(status!=='OK'){ setStatus('Itin√©raire indisponible ('+status+')'); routePanel.style.display='none'; return; }
      const leg = res.routes[0].legs[0];
      let totalSec = 0; const stepsOut=[];
      leg.steps.forEach(st=>{
        totalSec += (st.duration?.value)||0;
        if(st.travel_mode==='WALKING'){
          const pts=st.polyline? decodePolylinePts(st.polyline.points):[]; drawPolyline(pts, getCSS('--walk'), 3, '4 4'); stepsOut.push('√Ä pied ‚Äî '+Math.round(((st.duration?.value)||0)/60)+' min');
        } else if(st.travel_mode==='TRANSIT'){
          const td=st.transit; let col=getCSS('--bus'); let label='Bus';
          if(td?.line?.vehicle?.type==='SUBWAY'){
            const sn=(td.line.short_name||'').toUpperCase(); if(sn.includes('M1')) col=getCSS('--m1'), label='M√©tro M1'; else if(sn.includes('M2')) col=getCSS('--m2'), label='M√©tro M2'; else label='M√©tro';
          } else if(td?.line?.vehicle?.type==='TRAM'){ col=getCSS('--tram'); label=td.line.short_name||'Tram'; }
          const pts=st.polyline? decodePolylinePts(st.polyline.points):[]; drawPolyline(pts, col, 5, null);
          const stCnt = (td?.num_stops!=null)? (td.num_stops+' arr√™ts') : '';
          const mins=Math.round(((st.duration?.value)||0)/60);
          const name=(td && (td.line.short_name||td.line.name)) || label;
          stepsOut.push(name+' ‚Äî '+stCnt+' ¬∑ '+mins+' min');
        }
      });
      document.getElementById('routeTime').textContent = Math.round(totalSec/60)+' min';
      document.getElementById('routeSteps').innerHTML = '<ul style="margin:6px 0; padding-left:18px">'+ stepsOut.map(s=>'<li>'+s+'</li>').join('') +'</ul>';
      routePanel.style.display='block';
    });
  }

  // ---------- G√©ocodage ROBUSTE (file d'attente + retries + fallback) ----------
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  function cleanAddress(s){
    return (s||'')
      .replace(/\u00A0/g,' ')   // espace ins√©cable
      .replace(/\u2013/g,'-')   // tiret demi-cadratin
      .replace(/\s+/g,' ')
      .trim();
  }

  async function geocodeSmart(q, attempt=1){
    q = cleanAddress(q);
    // 1) tenter Places (plus permissif)
    const asPlaces = () => new Promise((resolve,reject)=>{
      placesSvc.findPlaceFromQuery({ query:q, fields:['geometry'] }, (res,status)=>{
        if(status==='OK' && res?.[0]?.geometry){ const L=res[0].geometry.location; resolve({lat:L.lat(), lon:L.lng()}); }
        else reject(status);
      });
    });
    // 2) secours Geocoder
    const asGeocoder = () => new Promise((resolve,reject)=>{
      geocoder.geocode({ address:q, componentRestrictions:{ country:'FR' } }, (res,status)=>{
        if(status==='OK' && res?.[0]){ const L=res[0].geometry.location; resolve({lat:L.lat(), lon:L.lng()}); }
        else reject(status);
      });
    });

    try{
      return await asPlaces();
    }catch(e1){
      try{
        return await asGeocoder();
      }catch(e2){
        // Gestion des erreurs transitoires
        const transient = (''+e1).includes('UNKNOWN_ERROR') || (''+e1).includes('OVER_QUERY_LIMIT') ||
                          (''+e2).includes('UNKNOWN_ERROR') || (''+e2).includes('OVER_QUERY_LIMIT');
        if(transient && attempt<=5){
          const wait = 250 * Math.pow(1.7, attempt); // backoff progressif
          await sleep(wait);
          return geocodeSmart(q, attempt+1);
        }
        throw (e2||e1);
      }
    }
  }

  async function placeSchools(){
    const formsPanel = document.getElementById('formsPanel');
    const formsTitle = document.getElementById('formsTitle');
    const formsContent = document.getElementById('formsContent');

    const markers=[];
    let done=0;
    for(const it of LYCEES){
      if(it.hidden) continue;
      const key = it.nom;
      try{
        let g = COORDS[key];
        if(!g){
          setStatus(`Placement des lyc√©es‚Ä¶ (${done+1}/${LYCEES.length})`);
          g = await geocodeSmart(`${it.nom}, ${it.adresse}`);
          COORDS[key]=g; saveCoords();
          await sleep(220); // throttling doux entre requ√™tes
        }
        const col = it.statut==='Public'? getCSS('--public') : getCSS('--prive');
        const m=L.circleMarker([g.lat,g.lon],{radius:5,color:col,fillColor:col,fillOpacity:1,weight:1}).addTo(map);
        m.bindTooltip(it.nom,{permanent:true,direction:'top',offset:[0,-8],className:'school-label'}).openTooltip();
        m.on('click',()=>{ routeTo({lat:g.lat,lon:g.lon}); showFormations(it); });
        markers.push(m);

        const searchText = normalize((it.cap||[]).join(' ') + ' ' + (it.bac||[]).join(' ') + ' ' + (it.seconde||[]).join(' ') + ' ' + it.nom);
        schoolMarkers.push({ marker:m, data:it, coords:g, searchText:searchText.toLowerCase() });
      }catch(e){
        console.warn('Geocode lyc√©e √©chou√©', it.nom, e);
      }finally{
        done++;
      }
    }
    if(markers.length){ const group=L.featureGroup(markers); map.fitBounds(group.getBounds().pad(0.2)); }
    setStatus('Pr√™t. Choisis un lyc√©e ou d√©finis un d√©part.');
  }

  function showFormations(s){
    let fp = document.getElementById('formsPanel');
    let ft = document.getElementById('formsTitle');
    let fc = document.getElementById('formsContent');
    if(!fp){
      fp = document.createElement('div'); fp.id='formsPanel'; fp.className='panel';
      fp.style.position='fixed'; fp.style.left='64px'; fp.style.bottom='160px'; fp.style.maxHeight='44vh'; fp.style.overflow='auto';
      ft = document.createElement('h4'); ft.id='formsTitle'; ft.textContent='Formations'; fp.appendChild(ft);
      fc = document.createElement('div'); fc.id='formsContent'; fp.appendChild(fc);
      document.body.appendChild(fp);
    } else {
      if(!ft){ ft = document.createElement('h4'); ft.id='formsTitle'; fp.prepend(ft); }
      if(!fc){ fc = document.createElement('div'); fc.id='formsContent'; fp.appendChild(fc); }
    }
    ft.textContent = s.nom;
    const cap = s.cap?.length ? ("<div class='row'><strong>CAP</strong><div>" + s.cap.map(x=>"<span class='tag'>"+x+"</span>").join('') + "</div></div>") : '';
    const bac = s.bac?.length ? ("<div class='row'><strong>Bac pro</strong><div>" + s.bac.map(x=>"<span class='tag'>"+x+"</span>").join('') + "</div></div>") : '';
    const sec = s.seconde?.length ? ("<div class='row'><strong>2nd pro</strong><div>" + s.seconde.map(x=>"<span class='tag'>"+x+"</span>").join('') + "</div></div>") : '';
    fc.innerHTML = (cap + bac + sec) || "<em style='color:#64748b'>Aucune formation renseign√©e</em>";
    fp.style.display = 'block';
  }

  // --- Overrides (identiques √† ta version corrig√©e) ---
  const OV = {
    "Lyc√©e Jacques Raynaud": {
      cap:["CAP Agent de s√©curit√©","CAP Installateur en froid et conditionnement d'air","CAP Maintenance des v√©hicules ‚Äì option v√©hicules l√©gers"],
      bac:[],
      seconde:["2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique","2nd pro M√©tiers du pilotage et de la maintenance d'installations automatis√©es"]
    },
    "Lyc√©e de l'Estaque": {
      cap:["CAP Agent de s√©curit√©","CAP Maintenance nautique","CAP √âlectricien","CAP √âquipier polyvalent du commerce"],
      bac:[],
      seconde:["2nd pro M√©tiers de la relation client","2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique"]
    },
    "Lyc√©e La Calade ‚Äì Jane Vialle": {
      cap:["CAP Esth√©tique cosm√©tique parfumerie","CAP M√©tiers de la mode ‚Äì V√™tement flou","CAP √âquipier polyvalent du commerce (EPC)"],
      bac:[],
      seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la relation client"]
    },
    "Lyc√©e Simone Veil": {
      cap:[], bac:["Bac pro Hygi√®ne, propret√©, st√©rilisation (HPS)"], seconde:[]
    },
    "Lyc√©e Antonin Artaud": {
      cap:["CAP √âlectricien"],
      bac:["Bac pro M√©tiers de l'√©lectricit√© et de ses environnements connect√©s (MELEC)"],
      seconde:["2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique"]
    },
    "Lyc√©e Blaise Pascal": {
      cap:["CAP Cordonnerie multiservice","CAP Op√©rateur en appareillage orthop√©dique ‚Äì sp√©cialit√© orthoproth√®se"],
      bac:[],
      seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la r√©alisation d'ensembles m√©caniques et industriels"]
    },
    "Lyc√©e Don Bosco": {
      cap:["CAP Menuisier fabricant","CAP M√©tallier","CAP Signal√©tique et d√©cors graphiques","CAP √âlectricien"],
      bac:[],
      seconde:["2nd pro M√©tiers des industries graphiques et de la communication","2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique","2nd pro M√©tiers du pilotage et de la maintenance d'installations automatis√©es"]
    },
    "Lyc√©e Saint-Michel": { cap:[], bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la relation client"] },
    "Lyc√©e Colbert": {
      cap:["CAP Accompagnant √©ducatif petite enfance (AEPE)","CAP Agent accompagnant au grand √¢ge","CAP Production et service en restaurations (rapide, collective, caf√©t√©ria) (PSR)","CAP √âquipier polyvalent du commerce (EPC)"],
      bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la relation client"]
    },
    "Lyc√©e Amp√®re": {
      cap:["CAP Agent de s√©curit√©","CAP Installateur en froid et conditionnement d'air","CAP √âlectricien"],
      bac:[], seconde:["2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique"]
    },
    "Lyc√©e Camille Jullian": {
      cap:["CAP Agent accompagnant au grand √¢ge","CAP Production et service en restaurations (PSR)","CAP √âquipier polyvalent du commerce (EPC)"],
      bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la relation client"]
    },
    "Lyc√©e Edmond Rostand": { cap:["CAP Accompagnant √©ducatif petite enfance (AEPE)"], bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique"] },
    "Lyc√©e La Floride": {
      cap:["CAP Conducteur routier de marchandises ‚Äì option livraisons de proximit√©","CAP Conducteur routier de marchandises ‚Äì option livraisons longue distance","CAP Maintenance des v√©hicules ‚Äì option motocycles","CAP Maintenance des v√©hicules ‚Äì option v√©hicules de transport routier","CAP Op√©rateur/op√©ratrice logistique","CAP √âlectricien"],
      bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la maintenance des mat√©riels et des v√©hicules","2nd pro M√©tiers des transitions num√©rique et √©nerg√©tique"]
    },
    "Lyc√©e Jean Perrin": {
      cap:["CAP Composites, plastiques chaudronn√©s","CAP R√©alisations industrielles en chaudronnerie ou soudage ‚Äì option A chaudronnerie"],
      bac:[], seconde:["2nd pro M√©tiers de la r√©alisation d'ensembles m√©caniques et industriels","2nd pro M√©tiers du pilotage et de la maintenance d'installations automatis√©es"]
    },
    "Lyc√©e Fr√©d√©ric Mistral": {
      cap:["CAP Carrossier automobile","CAP Maintenance des v√©hicules ‚Äì option v√©hicules l√©gers","CAP Signal√©tique et d√©cors graphiques"],
      bac:[], seconde:["2nd pro M√©tiers de la gestion administrative, du transport et de la logistique","2nd pro M√©tiers de la maintenance des mat√©riels et des v√©hicules","2nd pro M√©tiers de la relation client"]
    },
    "Lyc√©e Poinso-Chapuis": { cap:["CAP Maintenance nautique","CAP √âb√©niste"], bac:[], seconde:["2nd pro M√©tiers de l'agencement, de la menuiserie et de l'ameublement"] },
    "Lyc√©e Grande Bastide": { cap:[], bac:[], seconde:["2nd pro M√©tiers de l'h√¥tellerie-restauration"] },
    "Lyc√©e H√¥telier Jean-Paul Pass√©dat": { cap:["CAP Boulanger","CAP Commercialisation et services en h√¥tel-caf√©-restaurant (CSHCR)","CAP Cuisine","CAP P√¢tissier"], bac:[], seconde:["2nd pro M√©tiers de l'alimentation","2nd pro M√©tiers de l'h√¥tellerie-restauration"] },
    "Lyc√©e des Calanques": { cap:["CAPa Jardinier paysagiste"], bac:[], seconde:["2nd pro Nature-Jardin-Paysage-For√™t"] },
    "Lyc√©e Marie-Curie": { hidden:true }
  };

  for(const it of LYCEES){
    const o=OV[it.nom];
    if(o){
      if('cap' in o) it.cap=o.cap;
      if('bac' in o) it.bac=o.bac;
      if('seconde' in o) it.seconde=o.seconde;
      if('hidden' in o) it.hidden=o.hidden;
    }
  }

  // Lancer
  geocodeSmart(COLLEGE_ADDR).then(g=>{ setOrigin(g.lat, g.lon, COLLEGE_NAME); placeCollegeMarker(g.lat, g.lon); }).catch(()=>{ placeCollegeMarker(ORIGIN.lat, ORIGIN.lon); });
  placeSchools();

  // ====== Filtrage ======
  function normalize(s){ return (s||'').normalize('NFD').replace(/[ÃÄ-ÕØ]/g,''); }
  const SYNONYMS = {
    electricite: ['electricite','√©lectricit√©','electricien','√©lectricien','melec'],
    enfance: ['enfance','petite enfance','aepe'],
    logistique: ['logistique'],
    nautique: ['nautique','maintenance nautique'],
    cuisine: ['cuisine'],
    restauration: ['restauration','psr','csr','hcr','commercialisation et services'],
    mode: ['mode','vetement','v√™tement'],
    paysagiste: ['paysagiste','jardinier','amenagements paysagers','am√©nagements paysagers','am√©nagements'],
    securite: ['securite','s√©curit√©','agent de securite','agent de s√©curit√©'],
    coiffure: ['coiffure'],
    maroquinerie: ['maroquinerie','cuir'],
    commerce: ['commerce','epc','mcv','vente','accueil'],
    relationclient: ['relation client','mcv']
  };
  function expandQuery(q){
    q = normalize(q).toLowerCase().trim();
    if(!q) return [];
    const out = new Set([q]);
    for(const k in SYNONYMS){
      if(q.includes(k)) SYNONYMS[k].forEach(t => out.add(normalize(t).toLowerCase()));
    }
    return Array.from(out);
  }
  function applyFilter(){
    const q = document.getElementById('filterInput').value;
    const countEl = document.getElementById('filterCount');
    if(!q){ resetFilter(); return; }
    const terms = expandQuery(q);
    let shown=0; const shownMarkers=[];
    schoolMarkers.forEach(obj=>{
      const hit = terms.some(t => obj.searchText.includes(t));
      if(hit){ if(!map.hasLayer(obj.marker)) obj.marker.addTo(map); shown++; shownMarkers.push(obj.marker); }
      else { if(map.hasLayer(obj.marker)) map.removeLayer(obj.marker); }
    });
    if(shown>0){ const group=L.featureGroup(shownMarkers); map.fitBounds(group.getBounds().pad(0.2)); }
    if(countEl){ countEl.style.display='inline-block'; countEl.textContent = shown + ' r√©sultat' + (shown>1?'s':''); }
    if(typeof window.updateChipsUI==='function'){ window.updateChipsUI(); }
  }
  function resetFilter(){
    const countEl = document.getElementById('filterCount');
    schoolMarkers.forEach(obj=>{ if(!map.hasLayer(obj.marker)) obj.marker.addTo(map); });
    if(countEl){ countEl.style.display='none'; }
  }
  document.getElementById('applyFilter').onclick = applyFilter;
  document.getElementById('resetFilter').onclick = ()=>{ document.getElementById('filterInput').value=''; resetFilter(); if(typeof window.updateChipsUI==='function'){ window.updateChipsUI(); } };
  document.getElementById('filterInput').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ applyFilter(); } });
}
</script>
<script>
(function(){
  // UI des chips de filtre
  const toolbar=document.querySelector('.toolbar');
  if(toolbar && !document.getElementById('activeFilters')){
    const d=document.createElement('div'); d.id='activeFilters'; d.className='chips'; d.style.display='none'; toolbar.appendChild(d);
  }
  function sanitize(t){ return t.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[m])); }
  window.updateChipsUI = function(){
    const chipsEl=document.getElementById('activeFilters');
    const fi=document.getElementById('filterInput');
    const q=(fi&&fi.value||'').trim();
    if(!chipsEl) return;
    if(q){
      chipsEl.innerHTML = '<span class="chip">'+sanitize(q)+' <button title="Retirer">√ó</button></span>';
      chipsEl.style.display='flex';
      const btn=chipsEl.querySelector('button');
      if(btn) btn.onclick = ()=>{ if(fi){ fi.value=''; } if(typeof resetFilter==='function'){ resetFilter(); } window.updateChipsUI(); };
    } else { chipsEl.style.display='none'; chipsEl.innerHTML=''; }
  };
  const applyBtn=document.getElementById('applyFilter');
  if(applyBtn){ const prev=applyBtn.onclick; applyBtn.onclick=()=>{ if(typeof prev==='function') prev(); window.updateChipsUI(); }; }
  const resetBtn=document.getElementById('resetFilter');
  if(resetBtn){ const prevR=resetBtn.onclick; resetBtn.onclick=()=>{ if(typeof prevR==='function') prevR(); window.updateChipsUI(); }; }
  const fi=document.getElementById('filterInput');
  if(fi){ fi.addEventListener('keydown', e=>{ if(e.key==='Enter'){ if(typeof applyFilter==='function') applyFilter(); window.updateChipsUI(); } }); }
})();
</script>
</body>
</html>
